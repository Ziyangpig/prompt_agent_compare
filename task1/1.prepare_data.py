import json
import argparse

prompt = '''
你作为资深执业药师考试专家（Pharmaceutical Care Specialist, PCS），需严格遵循《中国药典》、《临床用药指南》、《药学综合知识与技能》、《药事管理与法规》、及药学专业知识进行分析。
请一步步仔细慎重思考，并按以下专业流程处理试题：

1. **题型识别与考点定位**
   - 明确本题属于（药理/药剂/法规/临床决策/临床用药/）
   - 明确本题 question_type 属于（最佳选择题/配伍选择题/综合分析选择题/多项选择题），
   - 关联2015-2024年真题高频考点数据库

2. **知识提取与交叉验证**
   • 关键概念：提取题干中3个核心术语（如：首过效应/治疗窗/DDD值）
   • 法规依据：若涉及药事管理，需引用《药品管理法》第X章第Y条或其他相关法规
   • 数值验证：剂量计算需双重核对《临床剂量速查手册》

3. **选项分析矩阵**
   注意，如果你要根据题干输入给你的question_type判断，如果不属于多项选择题，你必须更加严谨的对各个选项进行判断，最终选出最确信的一个选项
   | 选项 | 合理性 | 常见错误类型 | 相关指南条款 |
   |------|--------|--------------|--------------|

4. **决策树推演**
   → 若为非多项选择题：
       1) 排除明显不符合的选项
       2) 如果剩余选项多于1个, 回退, 重新审题，从更加严谨的角度对剩余选项进行选项分析;如果剩余选项只有一个，则跳转第三部
       3) 选出最符合题干要求的选项
   → 若为多项选择题：
       1) 排除明显不符合的选项
       2) 进一步审题，对于不完全确定的选项，从更严谨的角度重新进行选项分析
       3) 如果没有明显错误，则输出剩下的多个选项；如果重新分析发现有所变化，则重新输出
       
按照如下输出：
【选项评估】 
A) ✓ 正确：...[支持性文献]
B) ✗ 错误：...[典型认知误区]
C) ✗ 错误：...[与USP标准冲突处]

【结论】 
正确答案:X

example：
question: "2215. 可⽤于治疗蛔⾍病、蛲⾍病、钩⾍病和鞭⾍病的⼴谱驱⾍药物是（）。",
输出：
### 1. **题型识别与考点定位**
   - **题型**：最佳选择题（单选题）
   - **考点**：药理学/临床用药（广谱驱虫药物的适应症）
   - **关联高频考点**：2015-2024年真题中，广谱驱虫药的适应症是高频考点，尤其是甲苯咪唑和阿苯达唑的临床应用。

### 2. **知识提取与交叉验证**
   - **核心术语**：
     1. 广谱驱虫药
     2. 蛔虫病、蛲虫病、钩虫病、鞭虫病
     3. 甲苯咪唑
   - **法规依据**：《中国药典》和《临床用药指南》中明确甲苯咪唑为广谱驱虫药，覆盖题干中所有寄生虫病。
   - **数值验证**：无需剂量计算。

### 3. **选项分析矩阵**
   | 选项 | 合理性 | 常见错误类型 | 相关指南条款 |
   |------|--------|--------------|--------------|
   | A. 甲硝唑 | ✗ 错误 | 混淆抗寄生虫药与抗厌氧菌药 | 甲硝唑主要用于阿米巴病、滴虫病和厌氧菌感染 |
   | B. 氯硝柳胺 | ✗ 错误 | 混淆驱虫谱 | 氯硝柳胺主要用于绦虫病，对线虫无效 |
   | C. 乙胺嗪 | ✗ 错误 | 适应症错误 | 乙胺嗪仅用于丝虫病 |
   | D. 甲苯咪唑 | ✓ 正确 | 无 | 《中国药典》明确其为广谱驱虫药，覆盖蛔虫、蛲虫、钩虫、鞭虫 |
   | E. 三氯苯达唑 | ✗ 错误 | 适应症错误 | 主要用于吸虫病（如肝吸虫） |

### 4. **决策树推演**
   - **排除法**：
     1. 排除A（甲硝唑）：非驱虫药。
     2. 排除B（氯硝柳胺）：仅对绦虫有效。
     3. 排除C（乙胺嗪）：仅对丝虫有效。
     4. 排除E（三氯苯达唑）：仅对吸虫有效。
   - **剩余选项**：D（甲苯咪唑）完全符合题干描述的广谱驱虫适应症。

### 【选项评估】
   - A) ✗ 错误：甲硝唑不用于线虫感染。
   - B) ✗ 错误：氯硝柳胺对线虫无效。
   - C) ✗ 错误：乙胺嗪仅用于丝虫病。
   - D) ✓ 正确：甲苯咪唑是广谱驱线虫药。
   - E) ✗ 错误：三氯苯达唑对线虫无效。

### 【结论】
正确答案:D

输入：question": "112. 患者，男，70岁，因抑郁症长期服⽤舍曲林。新诊断为帕⾦森病，宜选⽤的药物有（）
输出：
### 1. **题型识别与考点定位**
   - **题型**：多项选择题（明确题干要求选择“宜选用的药物有”）
   - **考点**：临床用药（帕金森病药物选择与抗抑郁药舍曲林的相互作用）
   - **高频考点关联**：帕金森病药物机制、5-HT能系统与MAO抑制剂的相互作用（2015-2024年真题中多次涉及）。

### 2. **知识提取与交叉验证**
   - **核心术语**：
     1. **舍曲林**（SSRI类抗抑郁药，抑制5-HT再摄取）
     2. **司来吉兰**（MAO-B抑制剂，可能引发5-HT综合征与SSRI联用）
     3. **帕金森病治疗药物**（多巴胺受体激动剂、COMT抑制剂等）。
   - **法规依据**：《中国药典》及《临床用药指南》强调MAO抑制剂与SSRI联用的禁忌。
   - **数值验证**：无需剂量计算，但需注意药物相互作用风险。

### 3. **选项分析矩阵**
   | 选项      | 合理性                                                                 | 常见错误类型                     | 相关指南条款                                                                 |
   |-----------|------------------------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------|
   | **A. 司来吉兰** | ✗ 高风险：与舍曲林联用可能引发5-HT综合征（MAO-B抑制增加5-HT水平）       | 忽略MAO抑制剂与SSRI的相互作用    | 《临床用药指南》：MAO抑制剂禁与SSRI联用                                     |
   | **B. 普拉克索** | ✓ 安全：多巴胺受体激动剂，不依赖MAO代谢，无直接相互作用                 | 误认为所有帕金森药均需避免       | 《药学综合知识与技能》：普拉克索适用于合并抑郁的帕金森患者                  |
   | **C. 金刚烷胺** | ✓ 安全：通过促进多巴胺释放发挥作用，无5-HT能系统影响                    | 混淆抗病毒与抗帕金森作用机制     | 《中国药典》：金刚烷胺可用于帕金森病，无相关禁忌                            |
   | **D. 吡贝地尔** | ✓ 安全：多巴胺受体激动剂，无MAO抑制或5-HT能相互作用                     | 误判为MAO抑制剂                  | 《药事管理与法规》：吡贝地尔属非麦角类激动剂，安全性较高                    |
   | **E. 恩他卡朋** | ✓ 安全：COMT抑制剂，不干扰5-HT系统，可与舍曲林联用                      | 误认为COMT抑制剂影响MAO活性      | 《临床用药指南》：恩他卡朋仅抑制外周COMT，不影响中枢5-HT                    |

### 4. **决策树推演**
   - **排除法**：
     1. 排除**A（司来吉兰）**（高风险相互作用）。
     2. 其余选项（B、C、D、E）均无明确禁忌，机制合理。
   - **二次验证**：
     - **普拉克索（B）**、**金刚烷胺（C）**、**吡贝地尔（D）**、**恩他卡朋（E）**均通过不同机制改善帕金森症状，且不与舍曲林冲突。

### 【选项评估】
   - **A** ✗ 错误：MAO-B抑制剂与SSRI联用禁忌。
   - **B** ✓ 正确：多巴胺受体激动剂，安全。
   - **C** ✓ 正确：金刚烷胺无5-HT能影响。
   - **D** ✓ 正确：多巴胺受体激动剂，无相互作用。
   - **E** ✓ 正确：COMT抑制剂，外周作用，安全。

### 【结论】
正确答案:BCDE

下面是一道{question_type}，请先按以上步骤详细分析问题，最后给出选项，
1.再次提醒，不需要你来判断题型是什么，你只需要根据题干输入给你的{question_type}来进行判断，只有question_type为多项选择题时，才会有多个选项，不要擅自篡改题目类型，
2.如果非多选题你发现了多个答案，请重新思考，选择唯一的答案， 并保证【结论】 正确答案: 后只有一个字母。
3.请严格保证 【结论】后的输出内容的格式，不要有选项二字，直接输出A-E即可，不要有任何其他空格，或者也不要有**，标题等级markdown的符号，比如**等
{question}
{option}
'''

def generate_query(data):
    chatgpt_query = prompt
    question = data['question']
    option = '\n'.join([k+'. '+v for k,v in data['option'].items() if v != ''])
    chatgpt_query = chatgpt_query.format_map({'question':question,'option':option,'question_type':data['question_type']})
    return chatgpt_query


def Prepare_data(args):
    data = []
    # 读取上传的JSON文件
    with open(args.input_path, encoding='utf-8') as f:
        data = json.load(f)

    print(f"len:{len(data)}")
    # 根据要求转换
    jsonl_data = []


    for id, item in enumerate(data):
        jsonl_data.append(
            {
                "id":id,
                "query": generate_query(item),
                "model_answer": "",
                "question_type": item['question_type'],
                "groundtruth": item['answer']
            }
        )

    # 将转换后的数据保存为JSONL文件
    with open(args.output_path, "w", encoding="utf-8") as file:
        for entry in jsonl_data:
            file.write(json.dumps(entry, ensure_ascii=False) + "\n")
    
    print(f"Prepare finished, output to '{args.output_path}'")
            

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Prepare data for OpenAIGPT generation")
    parser.add_argument("--input_path", type=str, required=True, help="Path to the input JSON file.")
    parser.add_argument("--output_path", type=str, required=True, help="Path to the output JSONL file.")
    args = parser.parse_args()
    Prepare_data(args)
